<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/logo-mare.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MAR√â - Cat√°logo Mayorista</title>
    <meta name="description" content="Cat√°logo mayorista de accesorios MAR√â. Cintos, carteras, bijouterie y m√°s.">
    <meta name="theme-color" content="#8F6A50">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MAR√â">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- PWA para Windows -->
    <meta name="msapplication-TileImage" content="/icon-512.png">
    <meta name="msapplication-TileColor" content="#8F6A50">
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Firebase Push Notifications Integration -->
    <script type="module">
      // Solo cargar si est√° en producci√≥n (no localhost)
      if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        try {
          console.log('üîî Inicializando notificaciones MAR√â...');
          
          // Importar sistema de notificaciones
          import('./push-notifications.js').then(async (module) => {
            console.log('‚úÖ Sistema de notificaciones cargado');
            
            // Esperar un poco para no interrumpir la carga principal
            setTimeout(async () => {
              const notifications = window.mareNotifications;
              if (notifications && notifications.isSupported) {
                console.log('üîî Notificaciones disponibles');
                
                // Mostrar prompt de notificaciones despu√©s de 10 segundos
                setTimeout(async () => {
                  try {
                    const hasPermission = await notifications.requestPermission();
                    if (hasPermission) {
                      await notifications.subscribe();
                      console.log('‚úÖ Suscrito a notificaciones MAR√â');
                    }
                  } catch (error) {
                    console.log('‚ÑπÔ∏è Usuario no acept√≥ notificaciones');
                  }
                }, 10000); // 10 segundos despu√©s de cargar
              }
            }, 3000);
          });
        } catch (error) {
          console.log('‚ÑπÔ∏è Notificaciones no disponibles:', error.message);
        }
      }
    </script>
    
    <!-- Service Worker Registration -->
    <script>
      // Registrar Service Worker para PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          try {
            console.log('üîß Registrando Service Worker...');
            
            const registration = await navigator.serviceWorker.register('/sw.js', {
              scope: '/'
            });
            
            console.log('‚úÖ Service Worker registrado exitosamente:', registration);
            
            // Escuchar actualizaciones del Service Worker
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              console.log('üîÑ Nueva versi√≥n del Service Worker detectada');

              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed') {
                  newWorker.postMessage({ type: 'SKIP_WAITING' });
                }
              });
            });

            // Verificar peri√≥dicamente si hay nuevas versiones
            registration.update();
            setInterval(() => registration.update(), 60 * 60 * 1000);
            
            // Escuchar cuando el Service Worker toma control
            navigator.serviceWorker.addEventListener('controllerchange', () => {
              console.log('üîÑ Service Worker actualizado, recargando...');
              window.location.reload();
            });
            
            // Verificar si ya hay un Service Worker activo
            if (registration.active) {
              console.log('‚úÖ Service Worker ya activo');
            }
            
          } catch (error) {
            console.error('‚ùå Error registrando Service Worker:', error);
          }
        });
        
        // Escuchar mensajes del Service Worker
        navigator.serviceWorker.addEventListener('message', (event) => {
          if (event.data && event.data.version) {
            console.log('üì± Versi√≥n del Service Worker:', event.data.version);
          }
        });
      } else {
        console.warn('‚ö†Ô∏è Service Workers no soportados en este navegador');
      }

      // Detectar si la app es instalable (PWA)
      let deferredPrompt;
      
      window.addEventListener('beforeinstallprompt', (e) => {
        console.log('üì± App es instalable como PWA');
        
        // Prevenir el prompt autom√°tico
        e.preventDefault();
        
        // Guardar el evento para usarlo despu√©s
        deferredPrompt = e;
        
        // Mostrar indicador de que se puede instalar
        showInstallButton();
      });
      
      function showInstallButton() {
        // Crear bot√≥n de instalaci√≥n si no existe
        if (!document.getElementById('install-button')) {
          const installButton = document.createElement('button');
          installButton.id = 'install-button';
          installButton.innerHTML = 'üì± Instalar App';
          installButton.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #8F6A50;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 14px;
            transition: transform 0.2s, opacity 0.2s;
          `;
          
          installButton.addEventListener('mouseover', () => {
            installButton.style.transform = 'scale(1.05)';
          });
          
          installButton.addEventListener('mouseout', () => {
            installButton.style.transform = 'scale(1)';
          });
          
          installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
              // Mostrar el prompt de instalaci√≥n
              deferredPrompt.prompt();
              
              // Esperar la respuesta del usuario
              const { outcome } = await deferredPrompt.userChoice;
              
              if (outcome === 'accepted') {
                console.log('‚úÖ Usuario acept√≥ instalar la PWA');
              } else {
                console.log('‚ùå Usuario rechaz√≥ instalar la PWA');
              }
              
              // Limpiar el prompt
              deferredPrompt = null;
              installButton.remove();
            }
          });
          
          // Agregar el bot√≥n al DOM despu√©s de que se cargue la app
          setTimeout(() => {
            document.body.appendChild(installButton);
            
            // Animar entrada
            installButton.style.opacity = '0';
            installButton.style.transform = 'translateY(100px)';
            
            setTimeout(() => {
              installButton.style.transition = 'all 0.3s ease-out';
              installButton.style.opacity = '1';
              installButton.style.transform = 'translateY(0)';
            }, 100);
          }, 3000); // Esperar 3 segundos para no interrumpir la carga
        }
      }
      
      // Detectar cuando la app se instala
      window.addEventListener('appinstalled', () => {
        console.log('üéâ PWA instalada exitosamente');
        
        // Remover bot√≥n de instalaci√≥n si existe
        const installButton = document.getElementById('install-button');
        if (installButton) {
          installButton.remove();
        }
        
        // Opcional: Mostrar mensaje de bienvenida
        setTimeout(() => {
          alert('üéâ ¬°MAR√â instalado correctamente!\n\nYa puedes usar la app desde tu pantalla de inicio.');
        }, 1000);
      });
      
      // Debug: Mostrar estado de conexi√≥n
      function updateConnectionStatus() {
        const isOnline = navigator.onLine;
        console.log(isOnline ? 'üåê Online' : 'üì± Offline');
        
        // Opcional: Mostrar indicador visual de estado
        const connectionIndicator = document.getElementById('connection-status');
        if (connectionIndicator) {
          connectionIndicator.textContent = isOnline ? 'üåê' : 'üì±';
          connectionIndicator.title = isOnline ? 'Online' : 'Offline - Funcionando con datos guardados';
        }
      }
      
      // Escuchar cambios de conectividad
      window.addEventListener('online', updateConnectionStatus);
      window.addEventListener('offline', updateConnectionStatus);
      
      // Verificar conexi√≥n inicial
      document.addEventListener('DOMContentLoaded', updateConnectionStatus);
      
      console.log('üöÄ MAR√â PWA - Inicializaci√≥n completa');
    </script>
  </body>
</html>
